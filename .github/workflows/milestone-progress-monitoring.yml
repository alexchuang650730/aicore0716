name: PowerAutomation Milestone Progress Monitoring
description: Automated milestone tracking and progress monitoring system

on:
  schedule:
    # æ¯6å°æ™‚é‹è¡Œä¸€æ¬¡é€²åº¦æª¢æŸ¥
    - cron: '0 */6 * * *'
    # æ¯æ—¥ä¸Šåˆ9é»žç”Ÿæˆå®Œæ•´å ±å‘Š
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      force_notification:
        description: 'Force send notifications even if status is healthy'
        required: false
        default: 'false'
        type: boolean
      update_task_progress:
        description: 'Task ID and progress (format: task_id:progress)'
        required: false
        type: string

env:
  MONITORING_CONFIG: 'monitoring_config.yaml'
  PYTHON_VERSION: '3.11'

jobs:
  milestone-monitoring:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
        # å®‰è£ç›£æŽ§ç³»çµ±ä¾è³´
        pip install aiohttp PyGithub pyyaml gitpython
    
    - name: Create Monitoring Configuration
      run: |
        mkdir -p core/monitoring/config
        cat > core/monitoring/config/monitoring_config.yaml << EOF
        monitoring:
          check_interval_hours: 6
          report_interval_hours: 24
          risk_threshold_days: 7
          
        github:
          token: ${{ secrets.GITHUB_TOKEN }}
          repo: ${{ github.repository }}
          
        notifications:
          slack_webhook: ${{ secrets.SLACK_WEBHOOK }}
          email_recipients: 
            - ${{ secrets.NOTIFICATION_EMAIL }}
            
        milestones:
          data_file: 'core/monitoring/data/milestones_data.json'
          backup_dir: 'core/monitoring/backups'
          
        quality_gates:
          min_test_coverage: 80
          max_critical_issues: 0
          max_high_priority_bugs: 3
          required_reviewers: 2
        EOF
    
    - name: Initialize Monitoring Data Directory
      run: |
        mkdir -p core/monitoring/data
        mkdir -p core/monitoring/backups
        mkdir -p core/monitoring/logs
        mkdir -p core/monitoring/reports
    
    - name: Update Task Progress (if specified)
      if: github.event.inputs.update_task_progress != ''
      run: |
        cd core/monitoring
        python << EOF
        import asyncio
        import sys
        from milestone_progress_monitor import MilestoneProgressMonitor
        
        async def update_progress():
            monitor = MilestoneProgressMonitor('config/monitoring_config.yaml')
            progress_input = "${{ github.event.inputs.update_task_progress }}"
            
            if ':' in progress_input:
                task_id, progress = progress_input.split(':', 1)
                try:
                    progress_value = float(progress)
                    # å‡è¨­æ›´æ–°Q3é‡Œç¨‹ç¢‘çš„ä»»å‹™
                    await monitor.update_milestone_progress("milestone_4_8_0", task_id.strip(), progress_value)
                    print(f"âœ… ä»»å‹™ {task_id.strip()} é€²åº¦å·²æ›´æ–°è‡³ {progress_value}%")
                except ValueError:
                    print(f"âŒ ç„¡æ•ˆçš„é€²åº¦å€¼: {progress}")
                    sys.exit(1)
            else:
                print(f"âŒ ç„¡æ•ˆçš„è¼¸å…¥æ ¼å¼ï¼Œæ‡‰ç‚º task_id:progress")
                sys.exit(1)
        
        asyncio.run(update_progress())
        EOF
    
    - name: Run Milestone Progress Analysis
      id: analysis
      run: |
        cd core/monitoring
        python << EOF
        import asyncio
        import json
        import os
        from milestone_progress_monitor import MilestoneProgressMonitor
        
        async def run_analysis():
            monitor = MilestoneProgressMonitor('config/monitoring_config.yaml')
            
            # åŠ è¼‰é‡Œç¨‹ç¢‘æ•¸æ“š
            milestones = monitor.load_milestones_data()
            print(f"ðŸ“Š åŠ è¼‰äº† {len(milestones)} å€‹é‡Œç¨‹ç¢‘")
            
            # åŸ·è¡Œé€²åº¦åˆ†æž
            analysis = await monitor.analyze_progress(milestones)
            
            # ç”Ÿæˆå ±å‘Š
            report = await monitor.generate_report(analysis)
            
            # ä¿å­˜å ±å‘Šåˆ°artifacts
            import datetime
            timestamp = datetime.datetime.now().strftime('%Y%m%d_%H%M%S')
            
            with open(f'reports/milestone_report_{timestamp}.md', 'w', encoding='utf-8') as f:
                f.write(report)
            
            # è¼¸å‡ºåˆ°GitHub Actions
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                f.write(f"overall_status={analysis['overall_status']}\n")
                f.write(f"report_file=reports/milestone_report_{timestamp}.md\n")
                f.write(f"high_risk_count={len(analysis['risk_assessment']['high_risk_milestones'])}\n")
                f.write(f"recommendations_count={len(analysis['recommendations'])}\n")
            
            # ä¿å­˜åˆ†æžçµæžœç‚ºJSON
            with open(f'reports/analysis_{timestamp}.json', 'w', encoding='utf-8') as f:
                json.dump(analysis, f, ensure_ascii=False, indent=2)
            
            print(f"âœ… åˆ†æžå®Œæˆï¼Œç‹€æ…‹: {analysis['overall_status']}")
            print(f"ðŸ“‹ ç”Ÿæˆäº† {len(analysis['recommendations'])} æ¢å»ºè­°")
            
            # ç™¼é€é€šçŸ¥
            force_notification = "${{ github.event.inputs.force_notification }}" == "true"
            if analysis['overall_status'] != 'healthy' or force_notification:
                await monitor.send_notifications(analysis, report)
                print("ðŸ“§ å·²ç™¼é€ç‹€æ…‹é€šçŸ¥")
        
        asyncio.run(run_analysis())
        EOF
    
    - name: Quality Gate Check
      id: quality_gate
      run: |
        cd core/monitoring
        python << EOF
        import json
        import os
        import subprocess
        
        # é‹è¡Œæ¸¬è©¦å’Œè³ªé‡æª¢æŸ¥
        quality_results = {
            'test_coverage': 0,
            'critical_issues': 0,
            'high_priority_bugs': 0,
            'code_quality_score': 'A',
            'security_vulnerabilities': 0
        }
        
        # ç¤ºä¾‹ï¼šé‹è¡Œpytestç²å–è¦†è“‹çŽ‡
        try:
            result = subprocess.run(['python', '-m', 'pytest', '--cov=.', '--cov-report=json'], 
                                  capture_output=True, text=True, cwd='../..')
            if result.returncode == 0:
                # è§£æžè¦†è“‹çŽ‡å ±å‘Š
                try:
                    with open('../../coverage.json', 'r') as f:
                        coverage_data = json.load(f)
                        quality_results['test_coverage'] = coverage_data.get('totals', {}).get('percent_covered', 0)
                except FileNotFoundError:
                    pass
        except Exception as e:
            print(f"æ¸¬è©¦é‹è¡Œå¤±æ•—: {e}")
        
        # æª¢æŸ¥è³ªé‡é–€æª»
        min_coverage = 80
        max_critical = 0
        max_high_bugs = 3
        
        gate_passed = (
            quality_results['test_coverage'] >= min_coverage and
            quality_results['critical_issues'] <= max_critical and
            quality_results['high_priority_bugs'] <= max_high_bugs
        )
        
        with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
            f.write(f"quality_gate_passed={str(gate_passed).lower()}\n")
            f.write(f"test_coverage={quality_results['test_coverage']}\n")
            f.write(f"critical_issues={quality_results['critical_issues']}\n")
        
        print(f"ðŸ” è³ªé‡é–€æª»æª¢æŸ¥: {'âœ… é€šéŽ' if gate_passed else 'âŒ æœªé€šéŽ'}")
        print(f"ðŸ“Š æ¸¬è©¦è¦†è“‹çŽ‡: {quality_results['test_coverage']:.1f}%")
        print(f"ðŸ› åš´é‡å•é¡Œ: {quality_results['critical_issues']}")
        print(f"âš ï¸ é«˜å„ªå…ˆç´šbug: {quality_results['high_priority_bugs']}")
        EOF
    
    - name: Update Milestone Status Based on Quality Gate
      if: steps.quality_gate.outputs.quality_gate_passed == 'false'
      run: |
        cd core/monitoring
        python << EOF
        import asyncio
        from milestone_progress_monitor import MilestoneProgressMonitor
        
        async def update_risk_status():
            monitor = MilestoneProgressMonitor('config/monitoring_config.yaml')
            milestones = monitor.load_milestones_data()
            
            # å¦‚æžœè³ªé‡é–€æª»æœªé€šéŽï¼Œæé«˜é¢¨éšªç­‰ç´š
            for milestone in milestones:
                if milestone.status.value in ['in_progress']:
                    milestone.risk_factors.append("è³ªé‡é–€æª»æœªé€šéŽ")
                    if "æ¸¬è©¦è¦†è“‹çŽ‡ä¸è¶³" not in milestone.risk_factors:
                        milestone.risk_factors.append("æ¸¬è©¦è¦†è“‹çŽ‡ä¸è¶³")
                    
                    # æå‡é¢¨éšªç­‰ç´š
                    if milestone.risk_level.value == 'low':
                        milestone.risk_level = monitor.RiskLevel.MEDIUM
                    elif milestone.risk_level.value == 'medium':
                        milestone.risk_level = monitor.RiskLevel.HIGH
            
            monitor.save_milestones_data(milestones)
            print("âš ï¸ å·²æ ¹æ“šè³ªé‡é–€æª»çµæžœæ›´æ–°é¢¨éšªç‹€æ…‹")
        
        asyncio.run(update_risk_status())
        EOF
    
    - name: Create GitHub Issue for High Risk Milestones
      if: steps.analysis.outputs.high_risk_count > 0
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const highRiskCount = ${{ steps.analysis.outputs.high_risk_count }};
          
          if (highRiskCount > 0) {
            const issueTitle = `ðŸš¨ é«˜é¢¨éšªé‡Œç¨‹ç¢‘é è­¦ - ${highRiskCount} å€‹é‡Œç¨‹ç¢‘éœ€è¦é—œæ³¨`;
            const issueBody = `
          ## ðŸš¨ é‡Œç¨‹ç¢‘é¢¨éšªé è­¦
          
          **æª¢æ¸¬æ™‚é–“**: ${new Date().toISOString().split('T')[0]}
          **é«˜é¢¨éšªé‡Œç¨‹ç¢‘æ•¸é‡**: ${highRiskCount}
          
          ### ðŸ“Š é¢¨éšªæ¦‚è¦
          - æ•´é«”ç‹€æ…‹: ${{ steps.analysis.outputs.overall_status }}
          - å»ºè­°æ•¸é‡: ${{ steps.analysis.outputs.recommendations_count }}
          - è³ªé‡é–€æª»: ${{ steps.quality_gate.outputs.quality_gate_passed == 'true' ? 'âœ… é€šéŽ' : 'âŒ æœªé€šéŽ' }}
          
          ### ðŸ“ˆ è³ªé‡æŒ‡æ¨™
          - æ¸¬è©¦è¦†è“‹çŽ‡: ${{ steps.quality_gate.outputs.test_coverage }}%
          - åš´é‡å•é¡Œ: ${{ steps.quality_gate.outputs.critical_issues }}
          
          ### ðŸ“‹ å¾ŒçºŒè¡Œå‹•
          1. æŸ¥çœ‹è©³ç´°é‡Œç¨‹ç¢‘å ±å‘Š
          2. è©•ä¼°é¢¨éšªç·©è§£æŽªæ–½
          3. èª¿æ•´è³‡æºåˆ†é…
          4. é‡æ–°è©•ä¼°æ™‚é–“ç·š
          
          ### ðŸ“„ ç›¸é—œæ–‡ä»¶
          - è©³ç´°å ±å‘Š: ${{ steps.analysis.outputs.report_file }}
          - ç›£æŽ§é…ç½®: core/monitoring/config/monitoring_config.yaml
          
          **è‡ªå‹•ç”Ÿæˆ by PowerAutomation Monitoring System**
          `;
          
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨é¡žä¼¼çš„issue
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'milestone-risk,automated'
            });
            
            if (existingIssues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['milestone-risk', 'automated', 'priority-high']
              });
              
              console.log('âœ… å·²å‰µå»ºé«˜é¢¨éšªé‡Œç¨‹ç¢‘issue');
            } else {
              console.log('â„¹ï¸ å·²å­˜åœ¨é«˜é¢¨éšªé‡Œç¨‹ç¢‘issueï¼Œè·³éŽå‰µå»º');
            }
          }
    
    - name: Upload Monitoring Reports
      uses: actions/upload-artifact@v4
      with:
        name: milestone-monitoring-reports-${{ github.run_number }}
        path: |
          core/monitoring/reports/
          core/monitoring/logs/
        retention-days: 30
    
    - name: Post Summary to Pull Request
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          const summary = `
          ## ðŸ“Š é‡Œç¨‹ç¢‘ç›£æŽ§æ‘˜è¦
          
          | æŒ‡æ¨™ | å€¼ |
          |------|-----|
          | æ•´é«”ç‹€æ…‹ | ${{ steps.analysis.outputs.overall_status }} |
          | é«˜é¢¨éšªé‡Œç¨‹ç¢‘ | ${{ steps.analysis.outputs.high_risk_count }} |
          | æ”¹é€²å»ºè­° | ${{ steps.analysis.outputs.recommendations_count }} |
          | è³ªé‡é–€æª» | ${{ steps.quality_gate.outputs.quality_gate_passed == 'true' ? 'âœ… é€šéŽ' : 'âŒ æœªé€šéŽ' }} |
          | æ¸¬è©¦è¦†è“‹çŽ‡ | ${{ steps.quality_gate.outputs.test_coverage }}% |
          
          è©³ç´°å ±å‘Šè«‹æŸ¥çœ‹ Actions Artifacts ä¸­çš„ç›£æŽ§å ±å‘Šã€‚
          `;
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: summary
          });
    
    - name: Update Repository Status
      run: |
        # å‰µå»ºç‹€æ…‹æ–‡ä»¶
        mkdir -p .github/monitoring
        cat > .github/monitoring/status.json << EOF
        {
          "last_check": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "overall_status": "${{ steps.analysis.outputs.overall_status }}",
          "quality_gate_passed": ${{ steps.quality_gate.outputs.quality_gate_passed }},
          "test_coverage": ${{ steps.quality_gate.outputs.test_coverage }},
          "high_risk_milestones": ${{ steps.analysis.outputs.high_risk_count }},
          "workflow_run": "${{ github.run_number }}"
        }
        EOF
    
    - name: Commit Status Updates
      if: steps.analysis.outputs.overall_status != 'healthy' || github.event.inputs.update_task_progress != ''
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add core/monitoring/data/
        git add .github/monitoring/status.json
        
        if ! git diff --staged --quiet; then
          git commit -m "ðŸ¤– è‡ªå‹•æ›´æ–°é‡Œç¨‹ç¢‘ç›£æŽ§ç‹€æ…‹
          
          - æ•´é«”ç‹€æ…‹: ${{ steps.analysis.outputs.overall_status }}
          - é«˜é¢¨éšªé‡Œç¨‹ç¢‘: ${{ steps.analysis.outputs.high_risk_count }}
          - è³ªé‡é–€æª»: ${{ steps.quality_gate.outputs.quality_gate_passed == 'true' ? 'é€šéŽ' : 'æœªé€šéŽ' }}
          - å·¥ä½œæµé‹è¡Œ: #${{ github.run_number }}
          
          Generated by PowerAutomation Monitoring System"
          
          git push
          echo "âœ… ç›£æŽ§ç‹€æ…‹å·²æäº¤åˆ°å€‰åº«"
        else
          echo "â„¹ï¸ ç„¡éœ€æäº¤è®Šæ›´"
        fi
    
    outputs:
      overall_status: ${{ steps.analysis.outputs.overall_status }}
      quality_gate_passed: ${{ steps.quality_gate.outputs.quality_gate_passed }}
      report_file: ${{ steps.analysis.outputs.report_file }}
      high_risk_count: ${{ steps.analysis.outputs.high_risk_count }}