name: Milestone Tracking Automation

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  schedule:
    # æ¯æ—¥é€²åº¦æª¢æŸ¥ (UTC 01:00 = å°åŒ—æ™‚é–“ 09:00)
    - cron: '0 1 * * *'
  workflow_dispatch:
    inputs:
      milestone_version:
        description: 'é‡Œç¨‹ç¢‘ç‰ˆæœ¬ (å¦‚: v4.6.0)'
        required: false
        default: 'current'
      action_type:
        description: 'æ“ä½œé¡å‹'
        required: true
        default: 'progress_check'
        type: choice
        options:
          - progress_check
          - milestone_update
          - quality_gate_check
          - release_prepare

env:
  MILESTONE_CONFIG_PATH: 'MILESTONE_MANAGEMENT.md'
  ROADMAP_CONFIG_PATH: 'ROADMAP_2025.md'
  PYTHON_VERSION: '3.11'

jobs:
  prepare:
    name: æº–å‚™é‡Œç¨‹ç¢‘è¿½è¹¤ç’°å¢ƒ
    runs-on: ubuntu-latest
    outputs:
      current_milestone: ${{ steps.milestone-info.outputs.current_milestone }}
      milestone_progress: ${{ steps.milestone-info.outputs.progress }}
      target_date: ${{ steps.milestone-info.outputs.target_date }}
      risk_level: ${{ steps.milestone-info.outputs.risk_level }}
    
    steps:
      - name: Checkoutä»£ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: è¨­ç½®Pythonç’°å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: å®‰è£ä¾è³´
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests python-dateutil markdown

      - name: è§£æé‡Œç¨‹ç¢‘ä¿¡æ¯
        id: milestone-info
        run: |
          python << 'EOF'
          import os
          import re
          import json
          from datetime import datetime, timedelta
          
          def parse_milestone_management():
              """è§£æé‡Œç¨‹ç¢‘ç®¡ç†æ–‡æª”"""
              try:
                  with open('MILESTONE_MANAGEMENT.md', 'r', encoding='utf-8') as f:
                      content = f.read()
                  
                  # æå–ç•¶å‰é‡Œç¨‹ç¢‘ä¿¡æ¯
                  current_version_match = re.search(r'ä¸‹ä¸€é‡Œç¨‹ç¢‘.*?v(\d+\.\d+\.\d+)', content)
                  current_milestone = current_version_match.group(1) if current_version_match else "4.6.0"
                  
                  # æå–é€²åº¦
                  progress_match = re.search(r'å®Œæˆé€²åº¦.*?(\d+)%.*?â†’.*?(\d+)%', content)
                  current_progress = int(progress_match.group(2)) if progress_match else 0
                  
                  # æå–ç›®æ¨™æ—¥æœŸ
                  target_date_match = re.search(r'é è¨ˆç™¼å¸ƒ.*?(\d{4}-\d{2}-\d{2})', content)
                  target_date = target_date_match.group(1) if target_date_match else "2025-09-30"
                  
                  # è¨ˆç®—é¢¨éšªç­‰ç´š
                  target_dt = datetime.strptime(target_date, '%Y-%m-%d')
                  now = datetime.now()
                  days_remaining = (target_dt - now).days
                  time_elapsed_ratio = max(0, 1 - days_remaining / 365)  # å‡è¨­ä¸€å¹´å‘¨æœŸ
                  
                  if current_progress < time_elapsed_ratio * 80:
                      risk_level = "high"
                  elif current_progress < time_elapsed_ratio * 90:
                      risk_level = "medium"
                  else:
                      risk_level = "low"
                  
                  return {
                      'current_milestone': f"v{current_milestone}",
                      'progress': current_progress,
                      'target_date': target_date,
                      'risk_level': risk_level,
                      'days_remaining': days_remaining
                  }
              
              except Exception as e:
                  print(f"è§£æé‡Œç¨‹ç¢‘ç®¡ç†æ–‡æª”å¤±æ•—: {e}")
                  return {
                      'current_milestone': 'v4.6.0',
                      'progress': 0,
                      'target_date': '2025-09-30',
                      'risk_level': 'medium',
                      'days_remaining': 100
                  }
          
          milestone_info = parse_milestone_management()
          
          # è¨­ç½®GitHub Actionsè¼¸å‡º
          for key, value in milestone_info.items():
              print(f"::set-output name={key}::{value}")
              print(f"{key}: {value}")
          
          EOF

  milestone_progress_check:
    name: é‡Œç¨‹ç¢‘é€²åº¦æª¢æŸ¥
    runs-on: ubuntu-latest
    needs: prepare
    if: ${{ github.event.inputs.action_type == 'progress_check' || github.event.inputs.action_type == '' }}
    
    steps:
      - name: Checkoutä»£ç¢¼
        uses: actions/checkout@v4
      
      - name: è¨­ç½®Pythonç’°å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: å®‰è£ä¾è³´
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dateutil pyyaml matplotlib seaborn

      - name: åŸ·è¡Œé€²åº¦åˆ†æ
        id: progress-analysis
        run: |
          python << 'EOF'
          import os
          import re
          import json
          from datetime import datetime, timedelta
          
          class MilestoneProgressAnalyzer:
              def __init__(self):
                  self.current_milestone = "${{ needs.prepare.outputs.current_milestone }}"
                  self.current_progress = int("${{ needs.prepare.outputs.milestone_progress }}")
                  self.target_date = "${{ needs.prepare.outputs.target_date }}"
                  self.risk_level = "${{ needs.prepare.outputs.risk_level }}"
              
              def analyze_task_progress(self):
                  """åˆ†æå…·é«”ä»»å‹™é€²åº¦"""
                  try:
                      with open('MILESTONE_MANAGEMENT.md', 'r', encoding='utf-8') as f:
                          content = f.read()
                      
                      # æå–ä»»å‹™é€²åº¦
                      tasks = {
                          'ai_integration': self.extract_task_progress(content, 'AIæ¨¡å‹é›†æˆæ“´å±•'),
                          'mobile_testing': self.extract_task_progress(content, 'ç§»å‹•ç«¯æ¸¬è©¦æ”¯æ´'), 
                          'enterprise_features': self.extract_task_progress(content, 'ä¼æ¥­ç´šåŠŸèƒ½å¢å¼·')
                      }
                      
                      return tasks
                  except Exception as e:
                      print(f"åˆ†æä»»å‹™é€²åº¦å¤±æ•—: {e}")
                      return {}
              
              def extract_task_progress(self, content, task_name):
                  """æå–å–®å€‹ä»»å‹™çš„é€²åº¦"""
                  # æŸ¥æ‰¾ä»»å‹™ç›¸é—œçš„checkbox
                  pattern = rf'{task_name}.*?(\[ \]|\[x\])'
                  matches = re.findall(pattern, content, re.DOTALL)
                  
                  if not matches:
                      return 0
                  
                  completed = sum(1 for match in matches if '[x]' in match)
                  total = len(matches)
                  
                  return int((completed / total) * 100) if total > 0 else 0
              
              def generate_progress_report(self):
                  """ç”Ÿæˆé€²åº¦å ±å‘Š"""
                  tasks = self.analyze_task_progress()
                  
                  report = {
                      'milestone': self.current_milestone,
                      'overall_progress': self.current_progress,
                      'target_date': self.target_date,
                      'risk_level': self.risk_level,
                      'task_progress': tasks,
                      'analysis_date': datetime.now().isoformat(),
                      'recommendations': self.generate_recommendations(tasks)
                  }
                  
                  return report
              
              def generate_recommendations(self, tasks):
                  """ç”Ÿæˆæ”¹é€²å»ºè­°"""
                  recommendations = []
                  
                  for task, progress in tasks.items():
                      if progress < 50:
                          recommendations.append(f"ä»»å‹™ {task} é€²åº¦è½å¾Œï¼Œå»ºè­°åŠ å¼·è³‡æºæŠ•å…¥")
                      elif progress < 80:
                          recommendations.append(f"ä»»å‹™ {task} éœ€è¦æŒçºŒé—œæ³¨")
                  
                  if self.risk_level == 'high':
                      recommendations.append("æ•´é«”é¢¨éšªè¼ƒé«˜ï¼Œå»ºè­°é‡æ–°è©•ä¼°é‡Œç¨‹ç¢‘ç›®æ¨™")
                  
                  return recommendations
          
          analyzer = MilestoneProgressAnalyzer()
          report = analyzer.generate_progress_report()
          
          # ä¿å­˜å ±å‘Š
          os.makedirs('reports', exist_ok=True)
          with open('reports/milestone_progress_report.json', 'w', encoding='utf-8') as f:
              json.dump(report, f, indent=2, ensure_ascii=False)
          
          print("Progress Report Generated:")
          print(json.dumps(report, indent=2, ensure_ascii=False))
          
          # è¨­ç½®è¼¸å‡º
          print(f"::set-output name=risk_level::{report['risk_level']}")
          print(f"::set-output name=overall_progress::{report['overall_progress']}")
          
          EOF

      - name: ä¸Šå‚³é€²åº¦å ±å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: milestone-progress-report
          path: reports/milestone_progress_report.json

  quality_gate_check:
    name: è³ªé‡é–€ç¦æª¢æŸ¥  
    runs-on: ubuntu-latest
    needs: [prepare, milestone_progress_check]
    if: ${{ github.event.inputs.action_type == 'quality_gate_check' || github.event.inputs.action_type == '' }}
    
    steps:
      - name: Checkoutä»£ç¢¼
        uses: actions/checkout@v4
      
      - name: è¨­ç½®Pythonç’°å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: å®‰è£æ¸¬è©¦ä¾è³´
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-xdist
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: é‹è¡Œè³ªé‡é–€ç¦æ¸¬è©¦
        id: quality-gate
        run: |
          python << 'EOF'
          import subprocess
          import json
          import os
          from datetime import datetime
          
          class QualityGateChecker:
              def __init__(self):
                  self.results = {
                      'timestamp': datetime.now().isoformat(),
                      'checks': {},
                      'overall_status': 'unknown'
                  }
              
              def check_code_quality(self):
                  """æª¢æŸ¥ä»£ç¢¼è³ªé‡"""
                  try:
                      # æª¢æŸ¥æ˜¯å¦æœ‰Pythonä»£ç¢¼
                      result = subprocess.run(['find', '.', '-name', '*.py', '-type', 'f'], 
                                            capture_output=True, text=True)
                      python_files = result.stdout.strip().split('\n') if result.stdout.strip() else []
                      
                      if not python_files:
                          self.results['checks']['code_quality'] = {
                              'status': 'skipped',
                              'message': 'æ²’æœ‰æ‰¾åˆ°Pythonæ–‡ä»¶'
                          }
                          return
                      
                      # é‹è¡ŒåŸºæœ¬èªæ³•æª¢æŸ¥
                      syntax_errors = []
                      for file in python_files[:10]:  # é™åˆ¶æª¢æŸ¥æ–‡ä»¶æ•¸é‡
                          if os.path.exists(file):
                              result = subprocess.run(['python', '-m', 'py_compile', file], 
                                                    capture_output=True, text=True)
                              if result.returncode != 0:
                                  syntax_errors.append(f"{file}: {result.stderr}")
                      
                      self.results['checks']['code_quality'] = {
                          'status': 'passed' if not syntax_errors else 'failed',
                          'python_files_count': len(python_files),
                          'syntax_errors': syntax_errors
                      }
                  
                  except Exception as e:
                      self.results['checks']['code_quality'] = {
                          'status': 'error',
                          'error': str(e)
                      }
              
              def check_documentation(self):
                  """æª¢æŸ¥æ–‡æª”å®Œæ•´æ€§"""
                  try:
                      required_docs = [
                          'README.md',
                          'MILESTONE_MANAGEMENT.md', 
                          'ROADMAP_2025.md',
                          'PROJECT_ARCHITECTURE.md'
                      ]
                      
                      missing_docs = []
                      for doc in required_docs:
                          if not os.path.exists(doc):
                              missing_docs.append(doc)
                      
                      self.results['checks']['documentation'] = {
                          'status': 'passed' if not missing_docs else 'failed',
                          'required_docs': required_docs,
                          'missing_docs': missing_docs
                      }
                  
                  except Exception as e:
                      self.results['checks']['documentation'] = {
                          'status': 'error',
                          'error': str(e)
                      }
              
              def check_milestone_consistency(self):
                  """æª¢æŸ¥é‡Œç¨‹ç¢‘ä¸€è‡´æ€§"""
                  try:
                      # æª¢æŸ¥é‡Œç¨‹ç¢‘ç®¡ç†å’Œè·¯ç·šåœ–çš„ä¸€è‡´æ€§
                      with open('MILESTONE_MANAGEMENT.md', 'r', encoding='utf-8') as f:
                          milestone_content = f.read()
                      
                      with open('ROADMAP_2025.md', 'r', encoding='utf-8') as f:
                          roadmap_content = f.read()
                      
                      # ç°¡å–®æª¢æŸ¥ç‰ˆæœ¬è™Ÿä¸€è‡´æ€§
                      milestone_versions = re.findall(r'v(\d+\.\d+\.\d+)', milestone_content)
                      roadmap_versions = re.findall(r'v(\d+\.\d+\.\d+)', roadmap_content)
                      
                      common_versions = set(milestone_versions) & set(roadmap_versions)
                      
                      self.results['checks']['milestone_consistency'] = {
                          'status': 'passed' if common_versions else 'warning',
                          'milestone_versions': list(set(milestone_versions)),
                          'roadmap_versions': list(set(roadmap_versions)),
                          'common_versions': list(common_versions)
                      }
                  
                  except Exception as e:
                      self.results['checks']['milestone_consistency'] = {
                          'status': 'error',
                          'error': str(e)
                      }
              
              def run_all_checks(self):
                  """é‹è¡Œæ‰€æœ‰è³ªé‡é–€ç¦æª¢æŸ¥"""
                  print("ğŸ” é–‹å§‹è³ªé‡é–€ç¦æª¢æŸ¥...")
                  
                  self.check_code_quality()
                  self.check_documentation()  
                  self.check_milestone_consistency()
                  
                  # è¨ˆç®—æ•´é«”ç‹€æ…‹
                  failed_checks = [name for name, check in self.results['checks'].items() 
                                 if check.get('status') == 'failed']
                  error_checks = [name for name, check in self.results['checks'].items()
                                if check.get('status') == 'error']
                  
                  if error_checks:
                      self.results['overall_status'] = 'error'
                  elif failed_checks:
                      self.results['overall_status'] = 'failed'
                  else:
                      self.results['overall_status'] = 'passed'
                  
                  return self.results
          
          import re
          
          checker = QualityGateChecker()
          results = checker.run_all_checks()
          
          # ä¿å­˜çµæœ
          os.makedirs('reports', exist_ok=True)
          with open('reports/quality_gate_report.json', 'w', encoding='utf-8') as f:
              json.dump(results, f, indent=2, ensure_ascii=False)
          
          print("Quality Gate Results:")
          print(json.dumps(results, indent=2, ensure_ascii=False))
          
          # è¨­ç½®è¼¸å‡º
          print(f"::set-output name=overall_status::{results['overall_status']}")
          
          EOF

      - name: ä¸Šå‚³è³ªé‡é–€ç¦å ±å‘Š
        uses: actions/upload-artifact@v3
        with:
          name: quality-gate-report
          path: reports/quality_gate_report.json

  milestone_update:
    name: é‡Œç¨‹ç¢‘æ›´æ–°
    runs-on: ubuntu-latest
    needs: [prepare, milestone_progress_check, quality_gate_check]
    if: ${{ github.event.inputs.action_type == 'milestone_update' && github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkoutä»£ç¢¼
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: è¨­ç½®Pythonç’°å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: æ›´æ–°é‡Œç¨‹ç¢‘é€²åº¦
        run: |
          python << 'EOF'
          import re
          import os
          from datetime import datetime
          
          def update_milestone_progress():
              """æ›´æ–°é‡Œç¨‹ç¢‘é€²åº¦"""
              try:
                  # è®€å–ç•¶å‰é‡Œç¨‹ç¢‘ç®¡ç†æ–‡æª”
                  with open('MILESTONE_MANAGEMENT.md', 'r', encoding='utf-8') as f:
                      content = f.read()
                  
                  # æ›´æ–°æ™‚é–“æˆ³
                  timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                  
                  # åœ¨æ–‡æª”æœ«å°¾æ·»åŠ æ›´æ–°è¨˜éŒ„
                  update_record = f"""
          
          ---
          
          ## ğŸ“… è‡ªå‹•æ›´æ–°è¨˜éŒ„
          
          **æœ€å¾Œæ›´æ–°**: {timestamp}
          **æ›´æ–°ä¾†æº**: GitHub Actions è‡ªå‹•åŒ–å·¥ä½œæµ
          **ç•¶å‰é‡Œç¨‹ç¢‘**: ${{ needs.prepare.outputs.current_milestone }}
          **æ•´é«”é€²åº¦**: ${{ needs.prepare.outputs.milestone_progress }}%
          **é¢¨éšªç­‰ç´š**: ${{ needs.prepare.outputs.risk_level }}
          **è³ªé‡é–€ç¦**: ${{ needs.quality_gate_check.outputs.overall_status }}
          
          ### é€²åº¦è¿½è¹¤
          - è‡ªå‹•åŒ–é€²åº¦æª¢æŸ¥å·²é‹è¡Œ
          - è³ªé‡é–€ç¦æª¢æŸ¥å·²å®Œæˆ
          - é‡Œç¨‹ç¢‘ç‹€æ…‹å·²åŒæ­¥
          
          """
                  
                  # æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨è‡ªå‹•æ›´æ–°è¨˜éŒ„éƒ¨åˆ†
                  if '## ğŸ“… è‡ªå‹•æ›´æ–°è¨˜éŒ„' in content:
                      # æ›¿æ›ç¾æœ‰è¨˜éŒ„
                      content = re.sub(
                          r'---\s*## ğŸ“… è‡ªå‹•æ›´æ–°è¨˜éŒ„.*$',
                          update_record.strip(),
                          content,
                          flags=re.DOTALL
                      )
                  else:
                      # æ·»åŠ æ–°è¨˜éŒ„
                      content += update_record
                  
                  # å¯«å›æ–‡ä»¶
                  with open('MILESTONE_MANAGEMENT.md', 'w', encoding='utf-8') as f:
                      f.write(content)
                  
                  print("âœ… é‡Œç¨‹ç¢‘é€²åº¦å·²æ›´æ–°")
                  
              except Exception as e:
                  print(f"âŒ æ›´æ–°é‡Œç¨‹ç¢‘é€²åº¦å¤±æ•—: {e}")
                  return False
              
              return True
          
          success = update_milestone_progress()
          exit(0 if success else 1)
          
          EOF

      - name: æäº¤æ›´æ–°
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          if git diff --quiet; then
            echo "æ²’æœ‰è®Šæ›´éœ€è¦æäº¤"
          else
            git add MILESTONE_MANAGEMENT.md
            git commit -m "ğŸ¤– è‡ªå‹•æ›´æ–°é‡Œç¨‹ç¢‘é€²åº¦è¿½è¹¤

            - æ›´æ–°æ™‚é–“: $(date '+%Y-%m-%d %H:%M:%S')
            - ç•¶å‰é‡Œç¨‹ç¢‘: ${{ needs.prepare.outputs.current_milestone }}
            - æ•´é«”é€²åº¦: ${{ needs.prepare.outputs.milestone_progress }}%
            - é¢¨éšªç­‰ç´š: ${{ needs.prepare.outputs.risk_level }}
            - è³ªé‡é–€ç¦: ${{ needs.quality_gate_check.outputs.overall_status }}
            
            ç”± GitHub Actions è‡ªå‹•ç”Ÿæˆ"
            
            git push
            echo "âœ… é‡Œç¨‹ç¢‘æ›´æ–°å·²æäº¤"
          fi

  notification:
    name: é€šçŸ¥å’Œå ±å‘Š
    runs-on: ubuntu-latest
    needs: [prepare, milestone_progress_check, quality_gate_check]
    if: always()
    
    steps:
      - name: ä¸‹è¼‰å ±å‘Š
        uses: actions/download-artifact@v3
        with:
          name: milestone-progress-report
          path: reports/
        continue-on-error: true
      
      - name: ä¸‹è¼‰è³ªé‡é–€ç¦å ±å‘Š  
        uses: actions/download-artifact@v3
        with:
          name: quality-gate-report
          path: reports/
        continue-on-error: true

      - name: ç”Ÿæˆæ‘˜è¦å ±å‘Š
        run: |
          echo "## ğŸ¯ é‡Œç¨‹ç¢‘è¿½è¹¤æ‘˜è¦å ±å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**åŸ·è¡Œæ™‚é–“**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**ç•¶å‰é‡Œç¨‹ç¢‘**: ${{ needs.prepare.outputs.current_milestone }}" >> $GITHUB_STEP_SUMMARY
          echo "**æ•´é«”é€²åº¦**: ${{ needs.prepare.outputs.milestone_progress }}%" >> $GITHUB_STEP_SUMMARY
          echo "**ç›®æ¨™æ—¥æœŸ**: ${{ needs.prepare.outputs.target_date }}" >> $GITHUB_STEP_SUMMARY
          echo "**é¢¨éšªç­‰ç´š**: ${{ needs.prepare.outputs.risk_level }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ğŸ“Š æª¢æŸ¥çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.milestone_progress_check.result }}" = "success" ]; then
            echo "âœ… é€²åº¦æª¢æŸ¥: é€šé" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ é€²åº¦æª¢æŸ¥: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.quality_gate_check.result }}" = "success" ]; then
            echo "âœ… è³ªé‡é–€ç¦: é€šé" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ è³ªé‡é–€ç¦: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ é¢¨éšªè©•ä¼°" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          case "${{ needs.prepare.outputs.risk_level }}" in
            "high")
              echo "ğŸš¨ **é«˜é¢¨éšª**: é€²åº¦åš´é‡æ»¯å¾Œï¼Œéœ€è¦ç«‹å³æ¡å–è¡Œå‹•" >> $GITHUB_STEP_SUMMARY
              ;;
            "medium") 
              echo "âš ï¸ **ä¸­é¢¨éšª**: é€²åº¦è¼•å¾®æ»¯å¾Œï¼Œéœ€è¦å¯†åˆ‡é—œæ³¨" >> $GITHUB_STEP_SUMMARY
              ;;
            "low")
              echo "âœ… **ä½é¢¨éšª**: é€²åº¦æ­£å¸¸ï¼Œç¹¼çºŒä¿æŒ" >> $GITHUB_STEP_SUMMARY
              ;;
          esac
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“„ è©³ç´°å ±å‘Šè«‹æŸ¥çœ‹å·¥ä½œæµç”¢ç‰© (Artifacts)" >> $GITHUB_STEP_SUMMARY

      - name: å‰µå»ºIssueï¼ˆé«˜é¢¨éšªæ™‚ï¼‰
        if: ${{ needs.prepare.outputs.risk_level == 'high' }}
        uses: actions/github-script@v6
        with:
          script: |
            const title = `ğŸš¨ é‡Œç¨‹ç¢‘é¢¨éšªè­¦å‘Š: ${{ needs.prepare.outputs.current_milestone }}`;
            const body = `
            ## é‡Œç¨‹ç¢‘é¢¨éšªè­¦å‘Š
            
            **é‡Œç¨‹ç¢‘**: ${{ needs.prepare.outputs.current_milestone }}
            **ç•¶å‰é€²åº¦**: ${{ needs.prepare.outputs.milestone_progress }}%
            **ç›®æ¨™æ—¥æœŸ**: ${{ needs.prepare.outputs.target_date }}
            **é¢¨éšªç­‰ç´š**: ğŸš¨ é«˜é¢¨éšª
            
            ## å•é¡Œæè¿°
            ç•¶å‰é‡Œç¨‹ç¢‘é€²åº¦åš´é‡æ»¯å¾Œï¼Œå­˜åœ¨ç„¡æ³•æŒ‰æ™‚å®Œæˆçš„é¢¨éšªã€‚
            
            ## å»ºè­°è¡Œå‹•
            - [ ] é‡æ–°è©•ä¼°é‡Œç¨‹ç¢‘ç¯„åœå’Œç›®æ¨™
            - [ ] å¢åŠ è³‡æºæŠ•å…¥æˆ–èª¿æ•´äººå“¡é…ç½®  
            - [ ] è­˜åˆ¥å’Œç§»é™¤é˜»ç¤™å› ç´ 
            - [ ] è€ƒæ…®èª¿æ•´äº¤ä»˜æ™‚é–“ç·š
            
            ## è‡ªå‹•æª¢æŸ¥çµæœ
            - é€²åº¦æª¢æŸ¥: ${{ needs.milestone_progress_check.result }}
            - è³ªé‡é–€ç¦: ${{ needs.quality_gate_check.result }}
            
            _æ­¤Issueç”±GitHub Actionsè‡ªå‹•å‰µå»ºæ–¼ $(date '+%Y-%m-%d %H:%M:%S UTC')_
            `;
            
            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨é¡ä¼¼Issue
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'milestone-risk'
            });
            
            const duplicateIssue = existingIssues.data.find(issue => 
              issue.title.includes('${{ needs.prepare.outputs.current_milestone }}')
            );
            
            if (!duplicateIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['milestone-risk', 'priority-high', 'automated']
              });
              console.log('High risk issue created');
            } else {
              console.log('Similar high risk issue already exists');
            }